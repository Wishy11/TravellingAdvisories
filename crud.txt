const { app, BrowserWindow, ipcMain } = require('electron');
const path = require('path');
const fs = require('fs');

let mainWindow;

function createWindow() {
    mainWindow = new BrowserWindow({
        width: 1200,
        height: 800,
        webPreferences: {
            nodeIntegration: true,
            contextIsolation: true,
            preload: path.join(__dirname, 'preload.js')
        }
    });

    mainWindow.loadFile(path.join(__dirname, 'pages/index.html'));
}

ipcMain.handle('save-itinerary', async (event, itinerary) => {
    try {
        const customPath = path.join('C:', 'Users', 'User', 'OneDrive - Kolej Profesional MARA Indera Mahkota', 'Desktop', 'OOPCoding', 'TrvelAdvisor', 'textfiles');
        
        if (!fs.existsSync(customPath)) {
            fs.mkdirSync(customPath, { recursive: true });
        }

        // Create or update filename based on destination and ID (to maintain the same file)
        const sanitizedDestination = itinerary.destination.replace(/[^a-z0-9]/gi, '_');
        const fileName = `${sanitizedDestination}_${itinerary.id}.txt`;
        const filePath = path.join(customPath, fileName);

        // Format the itinerary content
        const content = `
Travel Itinerary
===============
Destination: ${itinerary.destination}
Date: ${itinerary.date}

Weather Information
-----------------
Temperature: ${itinerary.weather.temperature}째C
Condition: ${itinerary.weather.condition}
Forecast: ${itinerary.weather.forecast}째C average

Activities
---------
${itinerary.activities}

Notes
-----
${itinerary.notes}

Last Updated: ${new Date().toLocaleString()}
        `;

        // Write/overwrite file
        fs.writeFileSync(filePath, content, 'utf8');
        console.log('File saved/updated successfully at:', filePath);
        
        return { success: true, filePath };
    } catch (error) {
        console.error('Error saving/updating file:', error);
        return { success: false, error: error.message };
    }
});

ipcMain.handle('delete-itinerary', async (event, itinerary) => {
    try {
        const customPath = path.join('C:', 'Users', 'User', 'OneDrive - Kolej Profesional MARA Indera Mahkota', 'Desktop', 'OOPCoding', 'TrvelAdvisor', 'textfiles');
        
        // Create the filename using the same format as when saving
        const sanitizedDestination = itinerary.destination.replace(/[^a-z0-9]/gi, '_');
        const fileName = `${sanitizedDestination}_${itinerary.id}.txt`;
        const filePath = path.join(customPath, fileName);

        console.log('Attempting to delete file:', filePath);

        if (fs.existsSync(filePath)) {
            fs.unlinkSync(filePath);
            console.log('File deleted successfully:', filePath);
            return { 
                success: true, 
                message: 'File deleted successfully' 
            };
        } else {
            console.log('File not found:', filePath);
            return { 
                success: false, 
                error: 'File not found, might have been already deleted'
            };
        }
    } catch (error) {
        console.error('Error during file deletion:', error);
        return { 
            success: false, 
            error: error.message 
        };
    }
});

ipcMain.handle('read-itineraries', async () => {
    try {
        const customPath = path.join('C:', 'Users', 'User', 'OneDrive - Kolej Profesional MARA Indera Mahkota', 'Desktop', 'OOPCoding', 'TrvelAdvisor', 'textfiles');
        
        if (!fs.existsSync(customPath)) {
            fs.mkdirSync(customPath, { recursive: true });
            return { success: true, files: [] };
        }

        const files = fs.readdirSync(customPath)
            .filter(file => file.endsWith('.txt'))
            .map(fileName => {
                const filePath = path.join(customPath, fileName);
                const content = fs.readFileSync(filePath, 'utf8');
                
                // Parse the content to extract information
                const destination = content.match(/Destination: (.+)/)?.[1] || '';
                const date = content.match(/Date: (.+)/)?.[1] || '';
                const temperature = parseFloat(content.match(/Temperature: (.+)째C/)?.[1] || '0');
                const condition = content.match(/Condition: (.+)/)?.[1] || '';
                const forecast = parseFloat(content.match(/Forecast: (.+)째C/)?.[1] || '0');
                const activities = content.split('Activities\n---------\n')[1]?.split('\n\nNotes')[0]?.trim() || '';
                const notes = content.split('Notes\n-----\n')[1]?.split('\n\nLast Updated')[0]?.trim() || '';
                const id = parseInt(fileName.split('_').pop().split('.')[0]);

                return {
                    id,
                    fileName,
                    destination,
                    date,
                    activities,
                    notes,
                    weather: {
                        temperature,
                        condition,
                        forecast
                    }
                };
            });

        return { success: true, files };
    } catch (error) {
        console.error('Error reading itineraries:', error);
        return { success: false, error: error.message };
    }
});

ipcMain.handle('read-itinerary-file', async (event, id) => {
    try {
        const customPath = path.join('C:', 'Users', 'User', 'OneDrive - Kolej Profesional MARA Indera Mahkota', 'Desktop', 'OOPCoding', 'TrvelAdvisor', 'textfiles');
        
        // First get the list of files to find the correct one
        const files = fs.readdirSync(customPath)
            .filter(file => file.endsWith('.txt'));
            
        const targetFile = files.find(file => {
            const fileId = parseInt(file.split('_').pop().split('.')[0]);
            return fileId === id;
        });

        if (!targetFile) {
            return { 
                success: false, 
                error: 'File not found' 
            };
        }

        const filePath = path.join(customPath, targetFile);
        const content = fs.readFileSync(filePath, 'utf8');

        return { 
            success: true, 
            content: content 
        };
    } catch (error) {
        console.error('Error reading file:', error);
        return { 
            success: false, 
            error: error.message 
        };
    }
});

app.whenReady().then(createWindow);

app.on('window-all-closed', () => {
    if (process.platform !== 'darwin') {
        app.quit();
    }
});

app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
        createWindow();
    }
}); 